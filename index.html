<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Арабский тренажёр</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width:900px; margin:auto; }
    #intro { background: #fff; padding:16px; border-radius:8px; border:1px solid #ddd; margin-bottom:16px; }
    #intro h1 { margin-top:0; }
    #dua { direction: rtl; font-size:2em; margin:12px 0; font-weight:600; }
    #arabicWord { font-size:2rem; direction: rtl; margin:12px 0; font-weight:600; }
    input[type="text"]{ width:100%; padding:8px; font-size:1rem; box-sizing:border-box; }
    button{ padding:8px 12px; margin-top:8px; }
    #mistake-list { width:100%; min-height:120px; box-sizing:border-box; padding:8px; font-size:0.95rem; resize:vertical; }
    #controls, #trainer { margin-top:16px; }
    .small { font-size:0.9rem; color:#444; margin-top:6px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <!-- Начальный экран с дуа -->
  <div id="intro">
    <h1>Перед началом тренировок</h1>
    <p>Дуа:</p>
    <div id="dua">رَّبِّ زِدْنِى عِلْمًۭا</div>
    <p>Перевод: «Господь мой! Приумножь мои знания»</p>
    <button id="doneDua" disabled>Я сделал дуа</button>
  </div>

  <!-- Основной интерфейс (скрыт пока не сделают дуа) -->
  <div id="main" class="hidden">
    <h1>Арабский тренажёр</h1>

    <div id="progress" class="small"></div>
    <div id="arabicWord"></div>

    <input id="userInput" type="text" placeholder="Введите перевод на русском">
    <br>
    <button id="submitBtn">Ответить</button>

    <h3>Правильно:</h3>
    <div id="correct-list" class="small"></div>

    <h3>Ошибки (можно растянуть рамку мышью):</h3>
    <textarea id="mistake-list" readonly placeholder="Здесь будут ваши ошибки..."></textarea>
    <br>
    <button id="copyMistakesBtn">Копировать ошибки</button>
    <button id="clearMistakesBtn">Очистить ошибки</button>
  </div>

  <script>
    // Загружаем words.txt из корня
    let words = []; // { rawLine, ruVariants:[], arFull }
    let currentIndex = null;
    let mistakes = []; // сохраняем строки rawLine

    async function loadWords() {
      try {
        const res = await fetch('words.txt');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const txt = await res.text();
        const lines = txt.split(/\r?\n/).map(s => s.trim()).filter(s => s);
        words = lines.map(line => {
          const sepIndex = line.search(/[-–—]/);
          let ru = '', ar = '';
          if (sepIndex !== -1) {
            ru = line.slice(0, sepIndex).trim();
            ar = line.slice(sepIndex + 1).trim();
          } else {
            ru = line;
            ar = '';
          }
          const ruVariants = ru.split(',').map(r => r.trim().toLowerCase()).filter(r => r);
          return { rawLine: line, ruVariants, arFull: ar };
        });
        // включаем кнопку дуа только когда словарь загружен
        document.getElementById('doneDua').disabled = false;
        if (words.length === 0) {
          document.getElementById('arabicWord').textContent = 'Словарь пуст.';
        } else {
          prepareOrder();
          // не вызываем nextWord здесь — будет вызван после нажатия дуа
        }
      } catch (err) {
        // включим кнопку, чтобы пользователь мог продолжить даже без файла
        document.getElementById('doneDua').disabled = false;
        document.getElementById('arabicWord').textContent = 'Не удалось загрузить words.txt: ' + err;
      }
    }

    function shuffleIndices(n) {
      const arr = [...Array(n).keys()];
      for (let i = arr.length-1; i>0; i--) {
        const j = Math.floor(Math.random()*(i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    const order = []; // порядок индексов
    function prepareOrder() {
      order.length = 0;
      const idxs = shuffleIndices(words.length);
      for (const i of idxs) order.push(i);
    }

    function nextWord() {
      if (order.length === 0) prepareOrder();
      if (order.length === 0) {
        document.getElementById('arabicWord').textContent = 'Нет слов для тренировки.';
        return;
      }
      const idx = order.shift();
      currentIndex = idx;
      const w = words[idx];
      document.getElementById('arabicWord').textContent = w.arFull || w.rawLine;
      updateProgress();
      document.getElementById('userInput').value = '';
      document.getElementById('userInput').focus();
    }

    function normalizeRu(s) {
      return s.trim().toLowerCase().replace(/ё/g, 'е'); // е и ё считаем эквивалентными
    }

    function checkAnswer() {
      if (currentIndex === null) return;
      const inputRaw = document.getElementById('userInput').value;
      const input = normalizeRu(inputRaw);
      if (!input) return;
      const w = words[currentIndex];
      const ok = w.ruVariants.some(v => normalizeRu(v) === input || normalizeRu(v) === input.replace(/е/g,'ё') );
      if (ok) {
        const cl = document.getElementById('correct-list');
        const line = `${w.arFull} → ${inputRaw}`;
        cl.innerHTML += `<div>${escapeHtml(line)}</div>`;
      } else {
        mistakes.push(w.rawLine);
        updateMistakeTextarea();
      }
      currentIndex = null;
      nextWord();
    }

    function updateProgress() {
      const done = (typeof currentIndex === 'number') ? (1 + (words.length - order.length - 1)) : (words.length - order.length);
      document.getElementById('progress').textContent = `${done}/${words.length} слов пройдено – ${mistakes.length} ошибок`;
    }

    function updateMistakeTextarea() {
      const ta = document.getElementById('mistake-list');
      ta.value = mistakes.join('\n');
    }

    function copyMistakesToClipboard() {
      const content = document.getElementById('mistake-list').value;
      if (!content) {
        alert('Ошибок нет для копирования.');
        return;
      }
      navigator.clipboard.writeText(content).then(() => {
        alert('Ошибки скопированы в буфер обмена.');
      }).catch(err => {
        const ta = document.getElementById('mistake-list');
        ta.select();
        try {
          document.execCommand('copy');
          alert('Ошибки скопированы (fallback).');
        } catch(e) {
          alert('Не удалось скопировать: ' + e);
        }
      });
    }

    function clearMistakes() {
      if (!confirm('Очистить список ошибок?')) return;
      mistakes = [];
      updateMistakeTextarea();
      updateProgress();
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

    // события
    document.getElementById('submitBtn').addEventListener('click', checkAnswer);
    document.getElementById('userInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') { e.preventDefault(); checkAnswer(); }
    });
    document.getElementById('copyMistakesBtn').addEventListener('click', copyMistakesToClipboard);
    document.getElementById('clearMistakesBtn').addEventListener('click', clearMistakes);

    // кнопка дуа — скрывает intro и показывает тренажёр
    document.getElementById('doneDua').addEventListener('click', () => {
      document.getElementById('intro').classList.add('hidden');
      document.getElementById('main').classList.remove('hidden');
      // если слов уже загружены — начать
      if (words.length) nextWord();
    });

    // старт: загружаем слова
    loadWords();
  </script>
</body>
</html>
